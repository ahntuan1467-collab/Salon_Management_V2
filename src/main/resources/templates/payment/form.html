<div th:fragment="content">
    <div class="container mt-3">
        <h4 th:text="${payment.id == null ? '‚ûï Th√™m thanh to√°n' : '‚úèÔ∏è C·∫≠p nh·∫≠t thanh to√°n'}"></h4>

        <form th:action="${payment.id == null} ? @{/payment/save} : @{'/payment/update/' + payment.id}"
              method="post">

            <!-- üîπ Booking -->
            <div class="mb-3">
                <label for="bookingId" class="form-label">Ch·ªçn Booking</label>
                <select id="bookingId" name="bookingId" class="form-select" required onchange="updateServicePrice()">
                    <option value="">-- Ch·ªçn Booking --</option>
                    <option th:each="b : ${bookings}"
                            th:value="${b.id}"
                            th:text="${b.customer.name + ' - ' + b.service.name}"
                            th:data-price="${b.service.price}"
                            th:selected="${payment.bookingId == b.id}">
                    </option>
                </select>
            </div>

            <!-- üîπ Gi√° d·ªãch v·ª• -->
            <div class="mb-3">
                <label for="servicePrice" class="form-label">Gi√° d·ªãch v·ª• (VNƒê)</label>
                <input id="servicePrice" type="number" class="form-control" name="servicePrice"
                       th:value="${payment.servicePrice}" readonly />
            </div>

            <!-- üîπ Ch·ªçn Khuy·∫øn m√£i -->
            <div class="mb-3">
                <label for="promotionId" class="form-label">Ch·ªçn Khuy·∫øn m√£i (n·∫øu c√≥)</label>
                <select id="promotionId" name="promotionId" class="form-select" onchange="applyPromotion()">
                    <option value="">-- Kh√¥ng √°p d·ª•ng khuy·∫øn m√£i --</option>
                    <option th:each="p : ${promotions}"
                            th:value="${p.id}"
                            th:data-discount="${p.discount}"
                            th:text="${p.code + ' - ' + p.name + ' (' + p.discount + '%)'}"
                            th:selected="${payment.promotionId == p.id}">
                    </option>
                </select>
            </div>

            <!-- üîπ T·ªïng ti·ªÅn -->
            <div class="mb-3">
                <label for="finalAmount" class="form-label">T·ªïng ti·ªÅn thanh to√°n (VNƒê)</label>
                <input id="finalAmount" type="number" class="form-control" name="amount"
                       th:value="${payment.amount}" required readonly />
            </div>

            <!-- üîπ Ph∆∞∆°ng th·ª©c thanh to√°n -->
            <div class="mb-3">
                <label for="paymentMethod" class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                <select id="paymentMethod" class="form-select" name="paymentMethod" required>
                    <option value="Ti·ªÅn m·∫∑t" th:selected="${payment.paymentMethod == 'Ti·ªÅn m·∫∑t'}">Ti·ªÅn m·∫∑t</option>
                    <option value="Chuy·ªÉn kho·∫£n" th:selected="${payment.paymentMethod == 'Chuy·ªÉn kho·∫£n'}">Chuy·ªÉn kho·∫£n</option>
                    <option value="Th·∫ª" th:selected="${payment.paymentMethod == 'Th·∫ª'}">Th·∫ª</option>
                    <option value="QR" th:selected="${payment.paymentMethod == 'QR'}">QR</option>
                </select>
            </div>

            <!-- üîπ N√∫t h√†nh ƒë·ªông -->
            <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            <a th:href="@{/payment/list}" class="btn btn-secondary">‚¨Ö Quay l·∫°i</a>
        </form>
    </div>
</div>

<!-- ‚úÖ JavaScript x·ª≠ l√Ω t·ª± ƒë·ªông gi√° + khuy·∫øn m√£i -->
<script>
    // Khi ch·ªçn booking ‚Üí hi·ªÉn th·ªã gi√° d·ªãch v·ª•
    function updateServicePrice() {
        const bookingSelect = document.getElementById('bookingId');
        const selectedOption = bookingSelect.options[bookingSelect.selectedIndex];
        const price = selectedOption.getAttribute('data-price') || 0;

        document.getElementById('servicePrice').value = price;
        document.getElementById('finalAmount').value = price;

        // Reset khuy·∫øn m√£i khi ch·ªçn booking m·ªõi
        document.getElementById('promotionId').selectedIndex = 0;
    }

    // Khi ch·ªçn khuy·∫øn m√£i ‚Üí t√≠nh gi·∫£m gi√°
    function applyPromotion() {
        const promoSelect = document.getElementById('promotionId');
        const discount = parseFloat(promoSelect.options[promoSelect.selectedIndex].getAttribute('data-discount') || 0);
        const price = parseFloat(document.getElementById('servicePrice').value || 0);

        // ‚úÖ discount l√† 15 (nghƒ©a l√† 15%), n√™n ph·∫£i chia 100
        const finalPrice = price - (price * (discount / 100));
        document.getElementById('finalAmount').value = finalPrice.toFixed(0);
    }
</script>
